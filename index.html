
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>LOICA - Informe OOH</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Inter', sans-serif; 
    margin: 0; 
    padding: 24px; 
    background: #f5f5f5; 
    color: #000000; 
  }
  .topnav { 
    background: #6B0F0F; 
    color: #fff; 
    padding: 18px 24px; 
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
  }
  .brand { display: flex; align-items: center; gap: 12px; }
  .logo { width: 48px; height: 48px; background: #fff; border-radius: 6px; }
  .brand-text h1 { margin: 0; font-size: 18px; font-weight: 600; }
  .brand-text .subtitle { font-size: 12px; color: #f2f2f2; margin-top: 2px; }
  .menu { display: flex; gap: 8px; }
  .nav-btn { 
    background: transparent; 
    border: 1px solid rgba(255,255,255,0.2); 
    color: #fff; 
    padding: 8px 12px; 
    border-radius: 6px; 
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.1); }
  .nav-btn.active { background: #fff; color: #6B0F0F; border-color: #fff; font-weight: 600; }
  .header-right { color: #fff; font-size: 13px; }
  .container { max-width: 1200px; margin: 0 auto; }
  
  /* Views */
  .view { display: none; }
  .view.active { display: block; }
  
  /* Metrics */
  .metrics { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 12px; 
    margin-bottom: 24px;
  }
  .metric-card { 
    background: #fff; 
    border: 1px solid #e0e0e0; 
    padding: 18px; 
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }
  .metric-value { 
    font-size: 24px; 
    font-weight: 700; 
    color: #6B0F0F; 
    margin-bottom: 6px;
  }
  .metric-label { 
    font-size: 13px; 
    color: #666; 
  }
  
  /* Filters */
  .filters-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  .filters-section h3 { margin: 0 0 12px 0; }
  .filters-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #333;
  }
  .filter-group select {
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: 'Inter', sans-serif;
    min-width: 180px;
  }
  
  /* Custom multiselect */
  .custom-multiselect {
    position: relative;
    display: inline-block;
  }
  
  .multiselect-label {
    display: block;
    padding: 8px 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    font-size: 13px;
    color: #333;
    min-width: 180px;
    font-family: 'Inter', sans-serif;
  }
  
  .multiselect-label:hover {
    border-color: #6B0F0F;
  }
  
  .multiselect-options {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    min-width: 100%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .multiselect-options.active {
    display: block;
  }
  
  .multiselect-option {
    padding: 10px 12px;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .multiselect-option:hover {
    background: #f9f9f9;
  }
  
  .multiselect-option input[type="checkbox"] {
    cursor: pointer;
  }
  
  .multiselect-option label {
    cursor: pointer;
    margin: 0;
    flex: 1;
  }
  .btn {
    background: #6B0F0F;
    color: #fff;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: background 0.2s;
  }
  .btn:hover { background: #4a0a0a; }
  .btn-secondary {
    background: #999;
  }
  .btn-secondary:hover { background: #777; }
  
  /* Cards view */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px;
  }
  .location-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    transition: box-shadow 0.2s;
  }
  .location-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .location-card h3 { margin: 0 0 8px 0; font-size: 14px; }
  .location-card p { margin: 4px 0; font-size: 12px; color: #666; }
  .location-card .view-btn { width: 100%; margin-top: 10px; }
  
  /* Table view */
  .table-wrapper {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  table thead {
    background: #6B0F0F;
    color: #fff;
    position: sticky;
    top: 0;
  }
  table th, table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }
  table tbody tr:hover { background: #f9f9f9; }
  
  /* Full detail viewer */
  .full-detail {
    display: none;
    position: fixed;
    inset: 0;
    background: #fff;
    z-index: 9999;
    overflow: auto;
  }
  .full-detail.active { display: flex; }
  .detail-content {
    display: flex;
    gap: 20px;
    padding: 30px;
    max-width: 1400px;
    margin: 0 auto;
    align-items: flex-start;
  }
  .detail-image { flex: 1; }
  .detail-image img {
    width: 100%;
    height: 500px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.08);
  }
  .detail-info { flex: 1; }
  .detail-info h2 { margin: 0 0 12px 0; }
  .detail-info p { margin: 8px 0; font-size: 14px; }
  .detail-nav {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }
  .detail-nav button { flex: 1; }
  .detail-map { flex: 1; }
  .detail-map iframe {
    width: 100%;
    height: 520px;
    border: 0;
    border-radius: 8px;
  }
  .close-btn {
    position: absolute;
    top: 18px;
    right: 18px;
    background: #6B0F0F;
    color: #fff;
    border: none;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  
  footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
    color: #999;
    font-size: 12px;
  }
  #mapa {
    position: relative;
  }
  
  #mapa .filters-section {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 500;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  #map {
    width: 100% !important;
    height: 700px !important;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    margin-top: 0;
  }
  .leaflet-container {
    font-family: 'Inter', sans-serif;
  }
</style>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/2.8.2/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
</head>
<body>

<header class="topnav">
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div class="brand-text">
      <h1>LOICA</h1>
      <div class="subtitle">Informe OOH</div>
    </div>
  </div>
  <nav class="menu">
    <button class="nav-btn active" onclick="switchView('general')">Vista general</button>
    <button class="nav-btn" onclick="switchView('detail')">Detalle por ubicación</button>
    <button class="nav-btn" onclick="switchView('mapa')">Mapa</button>
    <button class="nav-btn" onclick="switchView('table')">Tabla completa</button>
  </nav>
  <div class="header-right">
    Total OOHs: <strong id="total-count">0</strong>
  </div>
</header>

<div class="container">
  
  <!-- GENERAL VIEW -->
  <div id="general" class="view active">
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-value" id="metric-total">0</div>
        <div class="metric-label">Total OOHs</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metric-marcas">0</div>
        <div class="metric-label">Marcas únicas</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metric-comunas">0</div>
        <div class="metric-label">Comunas cubiertas</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metric-regiones">0</div>
        <div class="metric-label">Regiones</div>
      </div>
    </div>
    
    <div style="margin-top: 30px; background: #fff; border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px;">
      <div style="display: flex; gap: 12px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
        <div class="filter-group">
          <label><strong>Filtrar por Comuna</strong></label>
          <div id="gen-comuna-filter"></div>
        </div>
        <div class="filter-group">
          <label><strong>Filtrar por Marca</strong></label>
          <div id="gen-marca-filter"></div>
        </div>
        <button class="btn" onclick="resetGeneralFilters()">Limpiar</button>
      </div>
      
      <h3 style="margin: 0 0 20px 0;">Cantidad de OOHs por Marca</h3>
      <div id="chart-marca-count" style="min-height: 400px;"></div>
    </div>
  </div>

  <!-- MAP VIEW -->
  <div id="mapa" class="view" style="position: relative; height: 750px;">
    <div id="map"></div>
    <div class="filters-section" style="position: absolute; top: 20px; left: 20px; z-index: 500; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
        <div class="filter-group">
          <label style="margin-bottom: 6px; display: block;"><strong>Filtrar por Marca</strong></label>
          <div id="mapa-marca-filter"></div>
        </div>
        <div class="filter-group">
          <label style="margin-bottom: 6px; display: block;"><strong>Filtrar por Soporte</strong></label>
          <div id="mapa-soporte-filter"></div>
        </div>
        <button class="btn" onclick="resetMapaFilters()">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- DETAIL VIEW -->
  <div id="detail" class="view">
    <div class="filters-section">
      <h3>Filtros</h3>
      <div class="filters-row">
        <div class="filter-group">
          <label>Marca</label>
          <div id="detail-marca-filter"></div>
        </div>
        <div class="filter-group">
          <label>Comuna</label>
          <div id="detail-comuna-filter"></div>
        </div>
        <div class="filter-group">
          <label>Región</label>
          <div id="detail-region-filter"></div>
        </div>
        <div class="filter-group">
          <label>Soporte</label>
          <div id="detail-soporte-filter"></div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn" onclick="applyDetailFilters()">Aplicar</button>
          <button class="btn btn-secondary" onclick="resetDetailFilters()">Reset</button>
        </div>
      </div>
    </div>
    <div id="detail-cards" class="cards-grid" style="margin-top: 20px;"></div>
  </div>

  <!-- TABLE VIEW -->
  <div id="table" class="view">
    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
      <button class="btn" onclick="downloadCSV()">Descargar CSV</button>
    </div>
    <div class="table-wrapper">
      <table id="data-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Full detail viewer -->
<div class="full-detail" id="full-detail">
  <button class="close-btn" onclick="closeFullDetail()">Cerrar</button>
  <div class="detail-content">
    <div class="detail-image">
      <div style="position: relative; width: 100%;">
        <img id="full-image" src="" alt="OOH Image" style="width: 100%; height: auto; border-radius: 8px;">
        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px; align-items: center;">
          <button class="btn" onclick="showPreviousImage()" id="prev-image-btn">◀ Anterior</button>
          <span id="image-counter" style="min-width: 60px; text-align: center; font-size: 14px;">1 / 2</span>
          <button class="btn" onclick="showNextImage()" id="next-image-btn">Siguiente ▶</button>
        </div>
      </div>
      <div class="detail-info">
        <h2 id="full-title"></h2>
        <p><strong>Marca:</strong> <span id="full-marca"></span></p>
        <p><strong>Comuna:</strong> <span id="full-comuna"></span></p>
        <p><strong>Región:</strong> <span id="full-region"></span></p>
        <p><strong>Tamaño:</strong> <span id="full-size"></span></p>
        <p><strong>Cantidad:</strong> <span id="full-screens"></span></p>
        <p><strong>Nivel de tráfico:</strong> <span id="full-traffic"></span></p>
        <p><strong>Velocidad (km/h):</strong> <span id="full-speed"></span></p>
        <p><strong>Soporte:</strong> <span id="full-soporte"></span></p>
        <p><strong>GSE:</strong> <span id="full-gse"></span></p>
        <div class="detail-nav">
          <button class="btn" onclick="showPreviousDetail()">◀ Anterior Ubicación</button>
          <button class="btn" onclick="showNextDetail()">Siguiente Ubicación ▶</button>
        </div>
      </div>
    </div>
    <div class="detail-map">
      <iframe id="full-map" src=""></iframe>
    </div>
  </div>
</div>

<footer>
  Reporte OOH — Generado automáticamente
</footer>

<script>
const entries = [{"id": 1, "Localización": "P.º Costanera 86, Papudo, Valparaíso", "Coordenadas": "32°30'21.7\"S 71°26'57.8\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.50602777777778, "lon": -71.44938888888889, "image": "https://picsum.photos/seed/0/900/500"}, {"id": 2, "Localización": "P.º Costanera 86, Papudo, Valparaíso", "Coordenadas": "32°30'21.7\"S 71°26'57.8\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.50602777777778, "lon": -71.44938888888889, "image": "https://picsum.photos/seed/1/900/500"}, {"id": 3, "Localización": "P.º Costanera 86, Papudo, Valparaíso", "Coordenadas": "32°30'21.7\"S 71°26'57.8\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Shweppes", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.50602777777778, "lon": -71.44938888888889, "image": "https://picsum.photos/seed/2/900/500"}, {"id": 4, "Localización": "E-30-F, Papudo, Valparaíso", "Coordenadas": "32°30'21.1\"S 71°26'40.0\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Señaletica", "GSE": "C1", "lat": -32.50586111111111, "lon": -71.44444444444444, "image": "https://picsum.photos/seed/3/900/500"}, {"id": 5, "Localización": "P.º Costanera 86, Papudo, Valparaíso", "Coordenadas": "32°30'18.5\"S 71°26'41.4\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.50513888888889, "lon": -71.44483333333334, "image": "https://picsum.photos/seed/4/900/500"}, {"id": 6, "Localización": "Avda glorias navales, Papudo, Valparaíso", "Coordenadas": "32°30'16.4\"S 71°26'36.9\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.504555555555555, "lon": -71.44358333333334, "image": "https://picsum.photos/seed/5/900/500"}, {"id": 7, "Localización": "Cacique Carande 1501, Papudo, Valparaíso", "Coordenadas": "32°30'31.8\"S 71°25'43.5\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.508833333333335, "lon": -71.42875000000001, "image": "https://picsum.photos/seed/6/900/500"}, {"id": 8, "Localización": "E-30-F, Papudo, Valparaíso", "Coordenadas": "32°30'19.7\"S 71°26'34.1\"W", "Comuna": "Papudo", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Valla Monumental", "GSE": "C1", "lat": -32.505472222222224, "lon": -71.44280555555557, "image": "https://picsum.photos/seed/7/900/500"}, {"id": 9, "Localización": "Cachagua 230, Zapallar, Valparaiso", "Coordenadas": "32°34'42.6\"S 71°26'57.7\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "AB", "lat": -32.578500000000005, "lon": -71.44936111111112, "image": "https://picsum.photos/seed/8/900/500"}, {"id": 10, "Localización": "Cachagua 230, Zapallar, Valparaiso", "Coordenadas": "32°34'42.6\"S 71°26'57.7\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Stella", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "AB", "lat": -32.578500000000005, "lon": -71.44936111111112, "image": "https://picsum.photos/seed/9/900/500"}, {"id": 11, "Localización": "2060135 Cachagua, Zapallar, Valparaíso", "Coordenadas": "32°34'41.4\"S 71°26'54.8\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Stella", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "AB", "lat": -32.57816666666667, "lon": -71.44855555555556, "image": "https://picsum.photos/seed/10/900/500"}, {"id": 12, "Localización": "Carlos León 700-730, La Laguna, Zapallar, Valparaíso", "Coordenadas": "32°37'46.3\"S 71°25'26.3\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Kunstman", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "AB", "lat": -32.62952777777778, "lon": -71.42397222222223, "image": "https://picsum.photos/seed/11/900/500"}, {"id": 13, "Localización": "Isidro Gaete 249, Puchuncaví, Zapallar, Valparaíso", "Coordenadas": "32°37'59.6\"S 71°25'37.3\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Miller", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "AB", "lat": -32.63322222222222, "lon": -71.42702777777778, "image": "https://picsum.photos/seed/12/900/500"}, {"id": 14, "Localización": "Maintencillo, Puchuncaví, Valparaíso", "Coordenadas": "32°38'12.5\"S 71°25'45.9\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -32.636805555555554, "lon": -71.42941666666667, "image": "https://picsum.photos/seed/13/900/500"}, {"id": 15, "Localización": "Av. del Mar 1280, Puchuncaví, Valparaíso", "Coordenadas": "32°38'35.1\"S 71°25'55.6\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Kunstman", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -32.64308333333333, "lon": -71.43211111111111, "image": "https://picsum.photos/seed/14/900/500"}, {"id": 16, "Localización": "Av. del Mar 1350, Puchuncaví, Valparaíso", "Coordenadas": "32°38'37.7\"S 71°25'57.1\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Sol", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -32.64380555555555, "lon": -71.43252777777778, "image": "https://picsum.photos/seed/15/900/500"}, {"id": 17, "Localización": "Av. del Mar, Puchuncaví, Valparaíso", "Coordenadas": "32°38'37.5\"S 71°25'57.6\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Pequeño", "Cantidad": 25, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Bandera", "GSE": "C2", "lat": -32.64375, "lon": -71.43266666666668, "image": "https://picsum.photos/seed/16/900/500"}, {"id": 18, "Localización": "Av. del Mar 1436, Puchuncaví, Valparaíso", "Coordenadas": "32°38'39.5\"S 71°25'59.6\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -32.644305555555555, "lon": -71.43322222222223, "image": "https://picsum.photos/seed/17/900/500"}, {"id": 19, "Localización": "Av. del Mar 2681, Puchuncaví, Valparaíso", "Coordenadas": "32°39'02.8\"S 71°26'35.0\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Stella", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -32.650777777777776, "lon": -71.44305555555556, "image": "https://picsum.photos/seed/18/900/500"}, {"id": 20, "Localización": "Pje. la Caleta, Puchuncaví, Valparaíso", "Coordenadas": "32°38'56.6\"S 71°26'23.8\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -32.649055555555556, "lon": -71.43994444444445, "image": "https://picsum.photos/seed/19/900/500"}, {"id": 21, "Localización": "Pje. Ignacio Baltra 133-12, Puchuncaví, Valparaíso", "Coordenadas": "32°38'56.1\"S 71°26'19.9\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -32.648916666666665, "lon": -71.43886111111111, "image": "https://picsum.photos/seed/20/900/500"}, {"id": 22, "Localización": "F-30-E, Puchuncaví, Valparaíso", "Coordenadas": "32°38'26.4\"S 71°25'26.1\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 70, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -32.64066666666667, "lon": -71.42391666666667, "image": "https://picsum.photos/seed/21/900/500"}, {"id": 23, "Localización": "Ruta F 30 E s/n Maitencillo, Puchuncaví, Valparaíso", "Coordenadas": "32°38'24.3\"S 71°25'26.0\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -32.64008333333333, "lon": -71.4238888888889, "image": "https://picsum.photos/seed/22/900/500"}, {"id": 24, "Localización": "F-30-E, Puchuncaví, Valparaíso", "Coordenadas": "32°38'24.3\"S 71°25'25.9\"W", "Comuna": "Maintencillo", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 70, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -32.64008333333333, "lon": -71.42386111111112, "image": "https://picsum.photos/seed/23/900/500"}, {"id": 25, "Localización": "La Laguna, Zapallar, Valparaíso", "Coordenadas": "32°37'59.1\"S 71°25'15.5\"W", "Comuna": "Zapallar", "Región": "Valparaíso", "Marca": "Miller", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Valla Monumental", "GSE": "AB", "lat": -32.63308333333333, "lon": -71.42097222222223, "image": "https://picsum.photos/seed/24/900/500"}, {"id": 26, "Localización": "Av. Borgoño 21455, Concón, Valparaíso", "Coordenadas": "32°55'49.6\"S 71°32'17.7\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.93044444444444, "lon": -71.53825, "image": "https://picsum.photos/seed/25/900/500"}, {"id": 27, "Localización": "Av. Borgoño 21270, Concón, Valparaíso", "Coordenadas": "32°55'47.2\"S 71°32'22.8\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.92977777777777, "lon": -71.53966666666666, "image": "https://picsum.photos/seed/26/900/500"}, {"id": 28, "Localización": "Av. Borgoño 21295, Concón, Valparaíso", "Coordenadas": "32°55'46.8\"S 71°32'23.7\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.92966666666666, "lon": -71.53991666666667, "image": "https://picsum.photos/seed/27/900/500"}, {"id": 29, "Localización": "Las Pimpinelas 1179, Concón, Valparaíso", "Coordenadas": "32°55'55.4\"S 71°32'31.3\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.93205555555555, "lon": -71.54202777777778, "image": "https://picsum.photos/seed/28/900/500"}, {"id": 30, "Localización": "Las Pimpinelas 101, Concón, Valparaíso", "Coordenadas": "32°55'52.5\"S 71°32'34.5\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.93125, "lon": -71.54291666666667, "image": "https://picsum.photos/seed/29/900/500"}, {"id": 31, "Localización": "Av. Concón Reñaca 4875, Concón, Valparaíso", "Coordenadas": "32°56'02.4\"S 71°32'26.5\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.934, "lon": -71.54069444444444, "image": "https://picsum.photos/seed/30/900/500"}, {"id": 32, "Localización": "Av. Concón Reñaca 83, 2510000 Concón, Valparaíso", "Coordenadas": "32°56'02.6\"S 71°32'28.5\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.93405555555555, "lon": -71.54125, "image": "https://picsum.photos/seed/31/900/500"}, {"id": 33, "Localización": "Av. Concón Reñaca 243, local 4, Concón, Valparaíso", "Coordenadas": "32°56'01.8\"S 71°31'58.8\"W", "Comuna": "Concon", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.93383333333333, "lon": -71.533, "image": "https://picsum.photos/seed/32/900/500"}, {"id": 34, "Localización": "Av. Borgoño 14966, Viña del Mar, Valparaíso", "Coordenadas": "32°58'01.8\"S 71°32'45.7\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Quitasol", "GSE": "C1", "lat": -32.96716666666667, "lon": -71.54602777777778, "image": "https://picsum.photos/seed/33/900/500"}, {"id": 35, "Localización": "Av. Borgoño 15036, Viña del Mar, Valparaíso", "Coordenadas": "32°58'03.3\"S 71°32'44.4\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.96758333333334, "lon": -71.54566666666666, "image": "https://picsum.photos/seed/34/900/500"}, {"id": 36, "Localización": "AV BORGOÑO 2FJ3+6R, Viña del Mar, Valparaíso", "Coordenadas": "32°58'10.7\"S 71°32'42.8\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.96963888888889, "lon": -71.54522222222222, "image": "https://picsum.photos/seed/35/900/500"}, {"id": 37, "Localización": "Av. Ignacio Carrera Pinto 55, Viña del Mar, Valparaíso", "Coordenadas": "32°58'18.1\"S 71°32'42.6\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Sol", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.971694444444445, "lon": -71.54516666666666, "image": "https://picsum.photos/seed/36/900/500"}, {"id": 38, "Localización": "Central, reñaca 14507, Viña del Mar, Valparaíso", "Coordenadas": "32°58'18.5\"S 71°32'41.8\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.971805555555555, "lon": -71.54494444444444, "image": "https://picsum.photos/seed/37/900/500"}, {"id": 39, "Localización": "Av. Borgoño 14411, Viña del Mar, Valparaíso", "Coordenadas": "32°58'21.6\"S 71°32'38.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Building Wrap", "GSE": "C1", "lat": -32.97266666666667, "lon": -71.54402777777777, "image": "https://picsum.photos/seed/38/900/500"}, {"id": 40, "Localización": "Angamos 152b, Viña del Mar, Valparaíso", "Coordenadas": "32°58'18.1\"S 71°32'35.7\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.971694444444445, "lon": -71.54325, "image": "https://picsum.photos/seed/39/900/500"}, {"id": 41, "Localización": "Las olas, reñaca 78, Viña del Mar, Valparaíso", "Coordenadas": "32°58'19.0\"S 71°32'40.3\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -32.971944444444446, "lon": -71.54452777777777, "image": "https://picsum.photos/seed/40/900/500"}, {"id": 42, "Localización": "Av. Borgoño 15266, Viña del Mar, Valparaíso", "Coordenadas": "32°57'58.6\"S 71°32'45.6\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Corona", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.96627777777778, "lon": -71.54599999999999, "image": "https://picsum.photos/seed/41/900/500"}, {"id": 43, "Localización": "Av. Borgoño 17150, Viña del Mar, Valparaíso", "Coordenadas": "32°57'19.4\"S 71°32'49.2\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.95538888888889, "lon": -71.547, "image": "https://picsum.photos/seed/42/900/500"}, {"id": 44, "Localización": "Av. Borgoño 17.120, Viña del Mar, Valparaíso", "Coordenadas": "32°57'20.8\"S 71°32'50.1\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.95577777777778, "lon": -71.54724999999999, "image": "https://picsum.photos/seed/43/900/500"}, {"id": 45, "Localización": "Patricio Lynch 37, Viña del Mar, Valparaíso", "Coordenadas": "32°58'20.1\"S 71°32'28.9\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.97225, "lon": -71.54136111111112, "image": "https://picsum.photos/seed/44/900/500"}, {"id": 46, "Localización": "Central 85, Viña del Mar, Valparaíso", "Coordenadas": "32°58'17.2\"S 71°32'38.9\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -32.971444444444444, "lon": -71.54413888888888, "image": "https://picsum.photos/seed/45/900/500"}, {"id": 47, "Localización": "San Antonio 1246, Viña del Mar, Valparaíso", "Coordenadas": "33°00'38.4\"S 71°32'33.6\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Escudo", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Transporte", "GSE": "C1", "lat": -33.010666666666665, "lon": -71.54266666666666, "image": "https://picsum.photos/seed/46/900/500"}, {"id": 48, "Localización": "Av. Jorge Montt, XCWX+2R2, Viña del Mar, Valparaíso", "Coordenadas": "33°00'19.4\"S 71°33'01.6\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -33.00538888888889, "lon": -71.55044444444444, "image": "https://picsum.photos/seed/47/900/500"}, {"id": 49, "Localización": "Av. San Martín 415, Viña del Mar, Valparaíso", "Coordenadas": "33°01'02.5\"S 71°33'31.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -33.01736111111111, "lon": -71.55875, "image": "https://picsum.photos/seed/48/900/500"}, {"id": 50, "Localización": "5 Nte. 384, 2520190 Viña del Mar, Valparaíso", "Coordenadas": "33°01'04.4\"S 71°33'16.7\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C1", "lat": -33.01788888888889, "lon": -71.55463888888889, "image": "https://picsum.photos/seed/49/900/500"}, {"id": 51, "Localización": "5 Nte. 476, 2520198 Viña del Mar, Valparaíso", "Coordenadas": "33°01'05.3\"S 71°33'11.9\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -33.018138888888885, "lon": -71.55330555555555, "image": "https://picsum.photos/seed/50/900/500"}, {"id": 52, "Localización": "5 Nte. 614, Viña del Mar, Valparaíso", "Coordenadas": "33°01'05.9\"S 71°33'06.3\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Austral", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C1", "lat": -33.01830555555556, "lon": -71.55175, "image": "https://picsum.photos/seed/51/900/500"}, {"id": 53, "Localización": "Avenida Benidorm 805, Valparaíso, Viña del Mar", "Coordenadas": "33°00'25.1\"S 71°32'43.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Stones", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Paleta", "GSE": "C1", "lat": -33.006972222222224, "lon": -71.54541666666667, "image": "https://picsum.photos/seed/52/900/500"}, {"id": 54, "Localización": "Avenida Benidorm 805, Valparaíso, Viña del Mar", "Coordenadas": "33°00'25.1\"S 71°32'43.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Sol", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Paleta", "GSE": "C1", "lat": -33.006972222222224, "lon": -71.54541666666667, "image": "https://picsum.photos/seed/53/900/500"}, {"id": 55, "Localización": "Avenida Benidorm 805, Valparaíso, Viña del Mar", "Coordenadas": "33°00'25.1\"S 71°32'43.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Paleta", "GSE": "C1", "lat": -33.006972222222224, "lon": -71.54541666666667, "image": "https://picsum.photos/seed/54/900/500"}, {"id": 56, "Localización": "Avenida Benidorm 805, Valparaíso, Viña del Mar", "Coordenadas": "33°00'25.1\"S 71°32'43.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Patagonia", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Paleta", "GSE": "C1", "lat": -33.006972222222224, "lon": -71.54541666666667, "image": "https://picsum.photos/seed/55/900/500"}, {"id": 57, "Localización": "Avenida Benidorm 805, Valparaíso, Viña del Mar", "Coordenadas": "33°00'25.1\"S 71°32'43.5\"W", "Comuna": "Viña del Mar", "Región": "Valparaíso", "Marca": "Kunstman", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Paleta", "GSE": "C1", "lat": -33.006972222222224, "lon": -71.54541666666667, "image": "https://picsum.photos/seed/56/900/500"}, {"id": 58, "Localización": "I-500, Pichilemu, O'Higgins", "Coordenadas": "34°25'24.5\"S 72°01'49.5\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 100, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -34.42347222222222, "lon": -72.03041666666667, "image": "https://picsum.photos/seed/57/900/500"}, {"id": 59, "Localización": "I-500, Pichilemu, O'Higgins", "Coordenadas": "34°25'21.6\"S 72°01'50.9\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Kunstman", "Tamaño": "Grande", "Cantidad": 2, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 100, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -34.422666666666665, "lon": -72.03080555555556, "image": "https://picsum.photos/seed/58/900/500"}, {"id": 60, "Localización": "Av. Comercio 1941, Pichilemu, O'Higgins", "Coordenadas": "34°24'12.1\"S 72°01'29.6\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.40336111111111, "lon": -72.02488888888888, "image": "https://picsum.photos/seed/59/900/500"}, {"id": 61, "Localización": "Av. Comercio 1953, Pichilemu, O'Higgins", "Coordenadas": "34°24'13.3\"S 72°01'29.6\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.40369444444444, "lon": -72.02488888888888, "image": "https://picsum.photos/seed/60/900/500"}, {"id": 62, "Localización": "Av. Comercio 1180, Pichilemu, O'Higgins", "Coordenadas": "34°23'50.1\"S 72°01'14.9\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39725, "lon": -72.02080555555555, "image": "https://picsum.photos/seed/61/900/500"}, {"id": 63, "Localización": "Av. Comercio 600, Pichilemu, O'Higgins", "Coordenadas": "34°23'29.4\"S 72°00'53.8\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.3915, "lon": -72.01494444444444, "image": "https://picsum.photos/seed/62/900/500"}, {"id": 64, "Localización": "El Arrayán 602, Pichilemu, O'Higgins", "Coordenadas": "34°23'26.8\"S 72°01'00.1\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39077777777778, "lon": -72.01669444444444, "image": "https://picsum.photos/seed/63/900/500"}, {"id": 65, "Localización": "Aviador Acevedo 600, Pichilemu, O'Higgins", "Coordenadas": "34°23'28.8\"S 72°01'01.1\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.391333333333336, "lon": -72.01697222222222, "image": "https://picsum.photos/seed/64/900/500"}, {"id": 66, "Localización": "Millaco 420, 3220000 Pichilemu, O'Higgins", "Coordenadas": "34°23'23.5\"S 72°00'50.0\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38986111111111, "lon": -72.01388888888889, "image": "https://picsum.photos/seed/65/900/500"}, {"id": 67, "Localización": "dionisio acevedo con, Federico Errázuriz, Pichilemu, O'Higgins", "Coordenadas": "34°23'11.3\"S 72°00'24.5\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.386472222222224, "lon": -72.00680555555556, "image": "https://picsum.photos/seed/66/900/500"}, {"id": 68, "Localización": "La Concepción 290A, Pichilemu, O'Higgins", "Coordenadas": "34°23'15.7\"S 72°00'00.8\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38769444444444, "lon": -72.00022222222222, "image": "https://picsum.photos/seed/67/900/500"}, {"id": 69, "Localización": "Aníbal Pinto 32, Pichilemu, O'Higgins", "Coordenadas": "34°23'10.9\"S 72°00'15.2\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.386361111111114, "lon": -72.00422222222223, "image": "https://picsum.photos/seed/68/900/500"}, {"id": 70, "Localización": "Aníbal Pinto 32, Pichilemu, O'Higgins", "Coordenadas": "34°23'10.9\"S 72°00'15.2\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.386361111111114, "lon": -72.00422222222223, "image": "https://picsum.photos/seed/69/900/500"}, {"id": 71, "Localización": "Aníbal Pinto 288, Pichilemu, O'Higgins", "Coordenadas": "34°23'14.1\"S 72°00'21.9\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Escudo", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -34.38725, "lon": -72.00608333333334, "image": "https://picsum.photos/seed/70/900/500"}, {"id": 72, "Localización": "Agustín Ross Edwards 392, Pichilemu, O'Higgins", "Coordenadas": "34°23'14.0\"S 72°00'28.1\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38722222222222, "lon": -72.00780555555555, "image": "https://picsum.photos/seed/71/900/500"}, {"id": 73, "Localización": "Agustín Ross Edwards 418, Pichilemu, O'Higgins", "Coordenadas": "34°23'13.6\"S 72°00'28.8\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -34.38711111111111, "lon": -72.008, "image": "https://picsum.photos/seed/72/900/500"}, {"id": 74, "Localización": "José Joaquín Prieto, Pichilemu, O'Higgins", "Coordenadas": "34°23'14.7\"S 72°00'27.3\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -34.38741666666667, "lon": -72.00758333333333, "image": "https://picsum.photos/seed/73/900/500"}, {"id": 75, "Localización": "Av. Costanera 826, Pichilemu, O'Higgins", "Coordenadas": "34°23'02.3\"S 72°00'48.9\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Alta", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C2", "lat": -34.38397222222222, "lon": -72.01358333333333, "image": "https://picsum.photos/seed/74/900/500"}, {"id": 76, "Localización": "Jorge Montt 190-A, Pichilemu, O'Higgins", "Coordenadas": "34°23'10.7\"S 72°00'53.6\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38630555555555, "lon": -72.01488888888889, "image": "https://picsum.photos/seed/75/900/500"}, {"id": 77, "Localización": "Dionisio Acevedo 81, Pichilemu, O'Higgins", "Coordenadas": "34°23'09.5\"S 72°00'28.6\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38597222222222, "lon": -72.00794444444445, "image": "https://picsum.photos/seed/76/900/500"}, {"id": 78, "Localización": "Av. Cáhuil 1371, Pichilemu, O'Higgins", "Coordenadas": "34°24'02.4\"S 71°59'45.0\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.400666666666666, "lon": -71.99583333333334, "image": "https://picsum.photos/seed/77/900/500"}, {"id": 79, "Localización": "Av. Cáhuil 1107, Pichilemu, O'Higgins", "Coordenadas": "34°23'55.7\"S 71°59'44.5\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.398805555555555, "lon": -71.99569444444444, "image": "https://picsum.photos/seed/78/900/500"}, {"id": 80, "Localización": "Av. Cáhuil 931, Pichilemu, O'Higgins", "Coordenadas": "34°23'49.7\"S 71°59'44.9\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39713888888889, "lon": -71.99580555555556, "image": "https://picsum.photos/seed/79/900/500"}, {"id": 81, "Localización": "Av. Cáhuil 768, Pichilemu, O'Higgins", "Coordenadas": "34°23'44.8\"S 71°59'44.2\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Royal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39577777777778, "lon": -71.99561111111112, "image": "https://picsum.photos/seed/80/900/500"}, {"id": 82, "Localización": "Av. Cáhuil 494, Pichilemu, O'Higgins", "Coordenadas": "34°23'34.0\"S 71°59'44.1\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39277777777778, "lon": -71.99558333333333, "image": "https://picsum.photos/seed/81/900/500"}, {"id": 83, "Localización": "Av. Cáhuil 55, Cahuil, Pichilemu, O'Higgins", "Coordenadas": "34°23'26.2\"S 71°59'44.8\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.39061111111111, "lon": -71.99577777777777, "image": "https://picsum.photos/seed/82/900/500"}, {"id": 84, "Localización": "Av. Cáhuil 197, Pichilemu, O'Higgins", "Coordenadas": "34°23'18.1\"S 71°59'48.6\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C2", "lat": -34.38836111111111, "lon": -71.99683333333333, "image": "https://picsum.photos/seed/83/900/500"}, {"id": 85, "Localización": "G-98-F 168, Las Cruces, El Tabo, Valparaíso", "Coordenadas": "33°30'33.8\"S 71°36'09.4\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C3", "lat": -33.509388888888886, "lon": -71.6026111111111, "image": "https://picsum.photos/seed/84/900/500"}, {"id": 86, "Localización": "G-98-F 14580, El Tabo, Valparaíso", "Coordenadas": "33°27'48.5\"S 71°38'52.6\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.46347222222222, "lon": -71.64794444444445, "image": "https://picsum.photos/seed/85/900/500"}, {"id": 87, "Localización": "Av. San Marcos 961, El Tabo, Valparaíso", "Coordenadas": "33°27'21.2\"S 71°39'54.7\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Restaurant", "GSE": "C3", "lat": -33.45588888888889, "lon": -71.66519444444445, "image": "https://picsum.photos/seed/86/900/500"}, {"id": 88, "Localización": "Arellano 1258, El Tabo, Valparaíso", "Coordenadas": "33°27'16.6\"S 71°40'02.7\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Alto", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.45461111111111, "lon": -71.66741666666667, "image": "https://picsum.photos/seed/87/900/500"}, {"id": 89, "Localización": "Arellano 1258, El Tabo, Valparaíso", "Coordenadas": "33°27'16.6\"S 71°40'02.7\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Becker", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Alto", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.45461111111111, "lon": -71.66741666666667, "image": "https://picsum.photos/seed/88/900/500"}, {"id": 90, "Localización": "Arellano 1189, El Tabo, Valparaíso", "Coordenadas": "33°27'16.7\"S 71°40'02.4\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.454638888888894, "lon": -71.66733333333333, "image": "https://picsum.photos/seed/89/900/500"}, {"id": 91, "Localización": "Valparaís, Av. Baquedano 17320, El Tabo, Valparaíso", "Coordenadas": "33°27'06.2\"S 71°40'25.2\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.45172222222222, "lon": -71.67366666666668, "image": "https://picsum.photos/seed/90/900/500"}, {"id": 92, "Localización": "Av. Isidoro Dubournais 534, El Quisco, Valparaíso", "Coordenadas": "33°23'59.5\"S 71°41'39.6\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.39986111111111, "lon": -71.69433333333333, "image": "https://picsum.photos/seed/91/900/500"}, {"id": 93, "Localización": "G-98-F 14960, El Tabo, Valparaíso", "Coordenadas": "33°27'43.2\"S 71°38'58.9\"W", "Comuna": "El Tabo", "Región": "Valparaíso", "Marca": "Becker", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.462, "lon": -71.64969444444445, "image": "https://picsum.photos/seed/92/900/500"}, {"id": 94, "Localización": "Av. Isidoro Dubournais 150, El Quisco, Valparaíso", "Coordenadas": "33°23'46.9\"S 71°41'39.9\"W", "Comuna": "El Quisco", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.39636111111111, "lon": -71.69441666666667, "image": "https://picsum.photos/seed/93/900/500"}, {"id": 95, "Localización": "Las Delicias 64, El Quisco, Valparaíso", "Coordenadas": "33°22'48.7\"S 71°41'10.2\"W", "Comuna": "El Quisco", "Región": "Valparaíso", "Marca": "Cristal", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Bajo", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.38019444444444, "lon": -71.68616666666667, "image": "https://picsum.photos/seed/94/900/500"}, {"id": 96, "Localización": "Av. Dr. Guillermo Mucke 1024, 2711311 Algarrobo, Valparaíso", "Coordenadas": "33°22'12.3\"S 71°40'02.6\"W", "Comuna": "Algarrobo", "Región": "Valparaíso", "Marca": "Heiniken", "Tamaño": "Pequeño", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Canal Tradicional", "GSE": "C3", "lat": -33.370083333333326, "lon": -71.6673888888889, "image": "https://picsum.photos/seed/95/900/500"}, {"id": 97, "Localización": "Av. Costanera 560, Cardenal Caro, Pichilemu, O'Higgins", "Coordenadas": "34°23'05.7\"S 72°00'33.8\"W", "Comuna": "Pichilemu", "Región": "O'Higgins", "Marca": "Corona", "Tamaño": "Grande", "Cantidad": 1, "Nivel de trafico promedio": "Medio", "Vel. (km/h)": 50, "Soporte": "Valla Monumental", "GSE": "C2", "lat": -34.38491666666667, "lon": -72.00938888888889, "image": "https://picsum.photos/seed/96/900/500"}];
let currentDetailIndex = 0;
let filteredEntries = entries;
let currentImageIndex = 0;
let currentEntryImages = [];

function getUniqueValues(key) {
  const set = new Set();
  entries.forEach(e => { if(e[key]) set.add(e[key]); });
  return Array.from(set).sort();
}

function getEntryImages(entry) {
  // Get images for this entry based on ID
  // Images are named like ID1_1.jpg, ID1_2.jpg, etc.
  // We return a promise that resolves with valid images
  const id = entry['id'];
  const images = [];
  
  // Check for images with format ID{id}_{number}.jpg and .jpeg
  // We'll check up to 10 possible images
  const imagePromises = [];
  
  for(let i = 1; i <= 10; i++) {
    const jpgUrl = `img/ID${id}_${i}.jpg`;
    const jpegUrl = `img/ID${id}_${i}.jpeg`;
    
    imagePromises.push(
      new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve({exists: true, url: jpgUrl});
        img.onerror = () => resolve({exists: false});
        img.src = jpgUrl;
      })
    );
    
    // Also check .jpeg
    if(i === 1) {
      imagePromises.push(
        new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({exists: true, url: jpegUrl});
          img.onerror = () => resolve({exists: false});
          img.src = jpegUrl;
        })
      );
    }
  }
  
  return Promise.all(imagePromises).then(results => {
    return results.filter(r => r.exists).map(r => ({url: r.url}));
  });
}function populateSelect(selectId, key) {
  const container = document.getElementById(selectId);
  if(!container) return;
  
  const values = getUniqueValues(key);
  container.innerHTML = '';
  container.className = 'custom-multiselect';
  
  const label = document.createElement('div');
  label.className = 'multiselect-label';
  label.textContent = `Seleccionar ${key}...`;
  
  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'multiselect-options';
  
  values.forEach(v => {
    const optDiv = document.createElement('div');
    optDiv.className = 'multiselect-option';
    optDiv.innerHTML = `
      <input type="checkbox" id="${selectId}_${v}" value="${v}" onchange="updateGeneralMetrics(); applyDetailFilters(); initializeFullMap();">
      <label for="${selectId}_${v}">${v}</label>
    `;
    optionsDiv.appendChild(optDiv);
  });
  
  label.onclick = (e) => {
    e.stopPropagation();
    optionsDiv.classList.toggle('active');
  };
  
  container.appendChild(label);
  container.appendChild(optionsDiv);
  
  // Close dropdown only when clicking outside the container
  document.addEventListener('click', (e) => {
    if(!container.contains(e.target)) {
      optionsDiv.classList.remove('active');
    }
  });
}

function getSelectedValues(selectId) {
  const container = document.getElementById(selectId);
  if(!container) return [];
  const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

let leafletMap = null;

function switchView(viewName) {
  // Hide all views
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  // Show selected view
  document.getElementById(viewName).classList.add('active');
  
  // Update nav buttons
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  
  // Initialize view-specific content
  if(viewName === 'detail') {
    populateSelect('detail-marca-filter', 'Marca');
    populateSelect('detail-comuna-filter', 'Comuna');
    populateSelect('detail-region-filter', 'Región');
    applyDetailFilters();
  } else if(viewName === 'mapa') {
    // Use a longer delay to ensure DOM is ready
    setTimeout(() => {
      const mapDiv = document.getElementById('map');
      if(mapDiv && mapDiv.offsetParent !== null) {
        initializeFullMap();
      } else {
        console.warn('Map container not visible');
      }
    }, 200);
  } else if(viewName === 'table') {
    renderTable();
  }
}

function updateGeneralMetrics() {
  // Get selected communes and marcas from filters
  const selectedComunas = getSelectedValues('gen-comuna-filter');
  const selectedMarcas = getSelectedValues('gen-marca-filter');
  
  // Filter entries based on selected communes and marcas (or all if none selected)
  const filtered = entries.filter(e => {
    const comunaMatch = selectedComunas.length === 0 || selectedComunas.includes(e['Comuna']);
    const marcaMatch = selectedMarcas.length === 0 || selectedMarcas.includes(e['Marca']);
    return comunaMatch && marcaMatch;
  });
  
  // Count marcas in filtered data
  const marcaCount = {};
  filtered.forEach(e => {
    const marca = e['Marca'] || 'Sin marca';
    marcaCount[marca] = (marcaCount[marca] || 0) + 1;
  });
  
  const uniqueMarcas = Object.keys(marcaCount).length;
  const uniqueComunas = new Set(filtered.map(e => e['Comuna'])).size;
  const uniqueRegiones = new Set(filtered.map(e => e['Región'])).size;
  
  document.getElementById('metric-total').textContent = filtered.length;
  document.getElementById('metric-marcas').textContent = uniqueMarcas;
  document.getElementById('metric-comunas').textContent = uniqueComunas;
  document.getElementById('metric-regiones').textContent = uniqueRegiones;
  
  // Create chart
  const labels = Object.keys(marcaCount).sort();
  const values = labels.map(k => marcaCount[k]);
  
  const trace = {
    x: labels,
    y: values,
    type: 'bar',
    marker: {
      color: labels.map((_, i) => {
        const palette = [
          '#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6',
          '#1ABC9C', '#C0392B', '#16A085', '#D35400', '#8E44AD',
          '#27AE60', '#E67E22', '#2980B9', '#C1392B', '#00BCD4',
          '#FF5722', '#673AB7', '#4CAF50', '#FFC107', '#F44336'
        ];
        return palette[i % palette.length];
      })
    }
  };
  
  const layout = {
    title: 'Cantidad de OOHs por Marca',
    xaxis: {title: 'Marca'},
    yaxis: {title: 'Cantidad'},
    plot_bgcolor: '#fafafa',
    paper_bgcolor: '#fff',
    margin: {b: 100, l: 60, r: 40, t: 60},
    font: {family: "'Inter', sans-serif"}
  };
  
  Plotly.newPlot('chart-marca-count', [trace], layout, {responsive: true});
}

function resetGeneralFilters() {
  // Uncheck all checkboxes in general filters
  document.getElementById('gen-comuna-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('gen-marca-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  updateGeneralMetrics();
}

function applyDetailFilters() {
  const marcas = getSelectedValues('detail-marca-filter');
  const comunas = getSelectedValues('detail-comuna-filter');
  const regiones = getSelectedValues('detail-region-filter');
  const soportes = getSelectedValues('detail-soporte-filter');
  
  filteredEntries = entries.filter(e => {
    const okMarca = marcas.length === 0 || marcas.includes(e['Marca']);
    const okComuna = comunas.length === 0 || comunas.includes(e['Comuna']);
    const okRegion = regiones.length === 0 || regiones.includes(e['Región']);
    const okSoporte = soportes.length === 0 || soportes.includes(e['Soporte']);
    return okMarca && okComuna && okRegion && okSoporte;
  });
  
  renderDetailCards();
}

function resetDetailFilters() {
  // Uncheck all checkboxes in detail filters
  document.getElementById('detail-marca-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('detail-comuna-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('detail-region-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('detail-soporte-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  filteredEntries = entries;
  renderDetailCards();
}

function renderDetailCards() {
  const container = document.getElementById('detail-cards');
  container.innerHTML = '';
  
  filteredEntries.forEach((entry, index) => {
    const realIndex = entries.indexOf(entry);
    const tamaño = entry['Tamaño (m)'] || entry['Tamaño'] || entry['tamaño'] || '';
    const card = document.createElement('div');
    card.className = 'location-card';
    card.innerHTML = `
      <h3>${entry['Localización'] || ''}</h3>
      <p><strong>Marca:</strong> ${entry['Marca'] || ''}</p>
      <p><strong>Comuna:</strong> ${entry['Comuna'] || ''}</p>
      <p><strong>Región:</strong> ${entry['Región'] || ''}</p>
      <p><strong>Tamaño:</strong> ${tamaño}</p>
      <p><strong>Soporte:</strong> ${entry['Soporte'] || ''}</p>
      <button class="btn view-btn" onclick="openFullDetail(${realIndex})">Ver</button>
    `;
    container.appendChild(card);
  });
  
  document.getElementById('total-count').textContent = filteredEntries.length;
}

function renderTable() {
  const table = document.getElementById('data-table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  
  if(entries.length === 0) return;
  
  const keys = Object.keys(entries[0]).filter(k => k !== 'image');
  
  thead.innerHTML = '<tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr>';
  tbody.innerHTML = '';
  
  entries.forEach(entry => {
    const row = document.createElement('tr');
    row.innerHTML = keys.map(k => `<td>${entry[k] || ''}</td>`).join('');
    tbody.appendChild(row);
  });
  
  document.getElementById('total-count').textContent = entries.length;
}

function openFullDetail(index) {
  currentDetailIndex = index;
  showFullDetail();
  document.getElementById('full-detail').classList.add('active');
}

function parseDMS(dmsString) {
  // Parse DMS format: "32°30'21.7"S 71°26'57.8"W"
  if(!dmsString) return null;
  
  const pattern = /(\d+)°(\d+)'([\d.]+)"([NSEW])\s+(\d+)°(\d+)'([\d.]+)"([NSEW])/;
  const match = dmsString.match(pattern);
  
  if(!match) return null;
  
  const latDeg = parseFloat(match[1]);
  const latMin = parseFloat(match[2]);
  const latSec = parseFloat(match[3]);
  const latDir = match[4];
  
  const lonDeg = parseFloat(match[5]);
  const lonMin = parseFloat(match[6]);
  const lonSec = parseFloat(match[7]);
  const lonDir = match[8];
  
  let lat = latDeg + latMin / 60 + latSec / 3600;
  let lon = lonDeg + lonMin / 60 + lonSec / 3600;
  
  if(latDir === 'S') lat = -lat;
  if(lonDir === 'W') lon = -lon;
  
  return {lat, lon};
}

function getCoordinates(entry) {
  // Try to parse coordinates from "Coordenadas" column first
  const coordenadas = entry['Coordenadas'];
  if(coordenadas) {
    const parsed = parseDMS(coordenadas);
    if(parsed) return parsed;
  }
  
  // Fallback to lat/lon fields
  const lat = entry['lat'];
  const lon = entry['lon'];
  if(lat && lon) {
    return {lat, lon};
  }
  
  return null;
}

function getColorPalette() {
  return [
    '#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6',
    '#1ABC9C', '#C0392B', '#16A085', '#D35400', '#8E44AD',
    '#27AE60', '#E67E22', '#2980B9', '#C1392B', '#00BCD4',
    '#FF5722', '#673AB7', '#4CAF50', '#FFC107', '#F44336'
  ];
}

function getMarcaColor(marca) {
  const marcas = getUniqueValues('Marca');
  const colorPalette = getColorPalette();
  const index = marcas.indexOf(marca);
  return colorPalette[index % colorPalette.length];
}

function resetMapaFilters() {
  // Uncheck all checkboxes in mapa filters
  document.getElementById('mapa-marca-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('mapa-soporte-filter').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  initializeFullMap();
}

function initializeFullMap() {
  const mapContainer = document.getElementById('map');
  if(!mapContainer) {
    console.error('Map container not found');
    return;
  }
  
  // Clear previous map if exists
  if(leafletMap) {
    leafletMap.remove();
    leafletMap = null;
  }
  
  // Initialize map centered on Chile
  const centerLat = -33.8688;
  const centerLon = -71.3093; // Santiago, Chile
  
  try {
    leafletMap = L.map('map', {
      preferCanvas: true
    }).setView([centerLat, centerLon], 7);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19,
      minZoom: 5
    }).addTo(leafletMap);
    
    const markerGroup = L.featureGroup();
    
    // Get selected Marcas and Soportes from filters
    const selectedMarcas = getSelectedValues('mapa-marca-filter');
    const selectedSoportes = getSelectedValues('mapa-soporte-filter');
    
    entries.forEach((entry, idx) => {
      // Filter by selected Marcas and Soportes (show all if none selected)
      if(selectedMarcas.length > 0 && !selectedMarcas.includes(entry['Marca'])) {
        return;
      }
      if(selectedSoportes.length > 0 && !selectedSoportes.includes(entry['Soporte'])) {
        return;
      }
      
      const coords = getCoordinates(entry);
      if(!coords) return;
      
      const {lat, lon} = coords;
      const marca = entry['Marca'] || 'Sin marca';
      const markerColor = getMarcaColor(marca);
      
      const popup = `<div style="font-size:12px;">
        <strong>${entry['Localización'] || ''}</strong><br>
        <strong>Marca:</strong> <span style="color:${markerColor}; font-weight:bold;">●</span> ${marca}<br>
        <strong>Comuna:</strong> ${entry['Comuna'] || ''}<br>
        <button onclick="openFullDetail(${idx})" style="margin-top:8px; padding:6px 10px; background:#6B0F0F; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Inter',sans-serif;">Ver detalle</button>
      </div>`;
      
      const marker = L.circleMarker([lat, lon], {
        radius: 6,
        fillColor: markerColor,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.85
      })
        .bindPopup(popup)
        .addTo(leafletMap);
      
      markerGroup.addLayer(marker);
    });
    
    // Create legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.backgroundColor = '#fff';
      div.style.padding = '12px';
      div.style.borderRadius = '6px';
      div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      div.style.maxHeight = '300px';
      div.style.overflowY = 'auto';
      div.style.fontFamily = "'Inter', sans-serif";
      div.style.fontSize = '12px';
      
      const marcas = getUniqueValues('Marca');
      let html = '<div style="font-weight:bold; margin-bottom:8px;">Marcas</div>';
      
      marcas.forEach(marca => {
        const color = getMarcaColor(marca);
        html += `<div style="margin:4px 0;">
          <span style="display:inline-block; width:12px; height:12px; background:${color}; border-radius:50%; margin-right:6px; vertical-align:middle;"></span>
          ${marca}
        </div>`;
      });
      
      div.innerHTML = html;
      return div;
    };
    legend.addTo(leafletMap);
    
    if(markerGroup.getLayers().length > 0) {
      leafletMap.fitBounds(markerGroup.getBounds().pad(0.1));
    } else {
      console.warn('No coordinates found for any entries');
    }
    
    // Trigger map resize after a brief delay to ensure proper rendering
    setTimeout(() => {
      if(leafletMap) {
        leafletMap.invalidateSize();
      }
    }, 300);
    
  } catch(e) {
    console.error('Error initializing map:', e);
  }
}

function showFullDetail() {
  const entry = entries[currentDetailIndex];
  if(!entry) return;
  
  document.getElementById('full-title').textContent = entry['Localización'] || '';
  document.getElementById('full-marca').textContent = entry['Marca'] || '';
  document.getElementById('full-comuna').textContent = entry['Comuna'] || '';
  document.getElementById('full-region').textContent = entry['Región'] || '';
  
  // Handle multiple possible column names for size
  const tamaño = entry['Tamaño (m)'] || entry['Tamaño'] || entry['tamaño'] || 'N/A';
  document.getElementById('full-size').textContent = tamaño;
  
  document.getElementById('full-screens').textContent = entry['Cantidad'] || '';
  document.getElementById('full-traffic').textContent = entry['Nivel de trafico promedio'] || '';
  document.getElementById('full-speed').textContent = entry['Vel. (km/h)'] || '';
  document.getElementById('full-soporte').textContent = entry['Soporte'] || '';
  document.getElementById('full-gse').textContent = entry['GSE'] || '';
  
  // Load available images for this entry (async)
  currentImageIndex = 0;
  getEntryImages(entry).then(images => {
    currentEntryImages = images;
    updateImageDisplay();
  });
  
  let mapSrc = '';
  
  // Try to parse coordinates from "Coordenadas" column first
  const coordenadas = entry['Coordenadas'];
  if(coordenadas) {
    const parsed = parseDMS(coordenadas);
    if(parsed) {
      const {lat, lon} = parsed;
      // Improved map URL with better zoom and marker visibility
      mapSrc = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1000!2d${lon}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0:0x0!2z${lat.toFixed(4)},${lon.toFixed(4)}!5e0!3m2!1sen!2sus!4v1234567890`;
    }
  }
  
  // Fallback to lat/lon if available
  if(!mapSrc) {
    const lat = entry['lat'];
    const lon = entry['lon'];
    if(lat && lon) {
      mapSrc = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1000!2d${lon}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0:0x0!2z${lat.toFixed(4)},${lon.toFixed(4)}!5e0!3m2!1sen!2sus!4v1234567890`;
    }
  }
  
  // Fallback to text search if no coordinates available
  if(!mapSrc) {
    const q = encodeURIComponent(entry['Localización'] || '');
    mapSrc = 'https://www.google.com/maps?q=' + q + '&output=embed';
  }
  
  document.getElementById('full-map').src = mapSrc;
}

function updateImageDisplay() {
  if(currentEntryImages.length === 0) {
    document.getElementById('full-image').src = '';
    document.getElementById('image-counter').textContent = '0 / 0';
    document.getElementById('prev-image-btn').disabled = true;
    document.getElementById('next-image-btn').disabled = true;
    return;
  }
  
  const currentImage = currentEntryImages[currentImageIndex];
  document.getElementById('full-image').src = currentImage.url;
  document.getElementById('image-counter').textContent = `${currentImageIndex + 1} / ${currentEntryImages.length}`;
  
  // Enable/disable buttons based on position
  document.getElementById('prev-image-btn').disabled = currentImageIndex === 0;
  document.getElementById('next-image-btn').disabled = currentImageIndex === currentEntryImages.length - 1;
}

function showPreviousImage() {
  if(currentImageIndex > 0) {
    currentImageIndex--;
    updateImageDisplay();
  }
}

function showNextImage() {
  if(currentImageIndex < currentEntryImages.length - 1) {
    currentImageIndex++;
    updateImageDisplay();
  }
}

function showPreviousDetail() {
  if(currentDetailIndex > 0) {
    currentDetailIndex--;
    showFullDetail();
  }
}

function showNextDetail() {
  if(currentDetailIndex < entries.length - 1) {
    currentDetailIndex++;
    showFullDetail();
  }
}

function closeFullDetail() {
  document.getElementById('full-detail').classList.remove('active');
}

function downloadCSV() {
  if(!entries.length) {
    alert('No hay datos para descargar');
    return;
  }
  
  const keys = Object.keys(entries[0]).filter(k => k !== 'image');
  const lines = [keys.join(',')];
  
  entries.forEach(row => {
    const vals = keys.map(k => {
      const v = row[k] === null || row[k] === undefined ? '' : String(row[k]).replace(/"/g, '""');
      return '"' + v + '"';
    });
    lines.push(vals.join(','));
  });
  
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'OOH_export.csv';
  document.body.appendChild(link);
  link.click();
  URL.revokeObjectURL(url);
  link.remove();
}

function downloadExcel() {
  if(!entries.length) {
    alert('No hay datos para descargar');
    return;
  }
  
  try {
    const keys = Object.keys(entries[0]).filter(k => k !== 'image');
    const data = entries.map(row => {
      const obj = {};
      keys.forEach(k => {
        obj[k] = row[k] || '';
      });
      return obj;
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'OOH Data');
    XLSX.writeFile(wb, 'LOICA_OOH_export.xlsx');
  } catch(e) {
    console.error('Error downloading Excel:', e);
    alert('Error descargando Excel: ' + e.message);
  }
}

document.addEventListener('keydown', (e) => {
  const isFullDetailOpen = document.getElementById('full-detail').classList.contains('active');
  if(!isFullDetailOpen) return;
  
  if(e.key === 'ArrowLeft') showPreviousDetail();
  else if(e.key === 'ArrowRight') showNextDetail();
  else if(e.key === 'Escape') closeFullDetail();
});

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  populateSelect('gen-comuna-filter', 'Comuna');
  populateSelect('gen-marca-filter', 'Marca');
  populateSelect('mapa-marca-filter', 'Marca');
  populateSelect('mapa-soporte-filter', 'Soporte');
  populateSelect('detail-marca-filter', 'Marca');
  populateSelect('detail-comuna-filter', 'Comuna');
  populateSelect('detail-region-filter', 'Región');
  populateSelect('detail-soporte-filter', 'Soporte');
  updateGeneralMetrics();
  
  document.getElementById('total-count').textContent = entries.length;
});

</script>

</body>
</html>